<!DOCTYPE html>
<html ng-app="analystApp">

<head>
    <title>Analyst Interface</title>
    <link rel="stylesheet" type="text/css" href="./lib/spectre.min.css" />
    <link rel="stylesheet" type="text/css" href="./lib/720kb.angular-datepicker/angular-datepicker.min.css" />
</head>

<body ng-controller="outliersCtrl" ng-init="initIndex()" style="min-height: 100vh;">
    <div class="container" style="height: 90vh">
        <div class="columns" style="height: 100%">
            <div ng-show="shoControlPannel" class="column col-12">
                <div class="column col-12">
                    <h3>Log Filter</h3>
                    <input type="checkbox" ng-model="asLocalFilter" ng-change="localFilter()" /> Also use as local display filter
                    <div class="columns">
                        <div class="column col-2">
                            <div class="input-group">
                                <span class="input-group-addon">Service</span>
                                <input class="form-input" type="text" ng-model="logFilter._source.log.service" placeholder="Service filter" />
                            </div>
                        </div>
                        <div class="column col-2">
                            <div class="input-group">
                                <span class="input-group-addon">IP</span>
                                <input class="form-input" type="text" ng-model="logFilter._source.log.ip" placeholder="IP filter" />
                            </div>
                        </div>
                        <div class="column col-2">
                            <div class="input-group">
                                <span class="input-group-addon">City</span>
                                <input class="form-input" type="text" ng-model="logFilter._source.log.city" placeholder="City filter" />
                            </div>
                        </div>
                        <div class="column col-2">
                            <div class="input-group">
                                <span class="input-group-addon">Region</span>
                                <input class="form-input" type="text" ng-model="logFilter._source.log.region" placeholder="Region filter" />
                            </div>
                        </div>
                        <div class="column col-2">
                            <div class="input-group">
                                <span class="input-group-addon">Country</span>
                                <input class="form-input" type="text" ng-model="logFilter._source.log.country" placeholder="Country filter" />
                            </div>
                        </div>
                    </div>
                    <div class="columns">
                        <div class="column col-2">
                            <datepicker date-format="yyyy-MM-dd" selector="form-input">
                                <div class="input-group">
                                    <span class="input-group-addon">Start</span>
                                    <input class="form-input" type="text" ng-model="logMgr.startDate" />
                                </div>
                            </datepicker>
                        </div>
                        <div class="column col-2">
                            <datepicker date-format="yyyy-MM-dd" selector="form-input">
                                <div class="input-group">
                                    <span class="input-group-addon">End</span>
                                    <input class="form-input" type="text" ng-model="logMgr.endDate" />
                                </div>
                            </datepicker>
                        </div>
                        <div class="column col-2">
                            <div class="input-group">
                                <span class="input-group-addon">Query Size</span>
                                <input class="form-input" type="number" ng-model="logMgr.querySize" placeholder="Query Size" />
                            </div>
                        </div>
                        <div class="column col-2">
                            <button class="btn btn-primary" ng-click="initLogScroll()">Query Matched Logs</button>
                        </div>
                        <div class="column col-4">
                            <div class="float-right">
                                <button class="btn" ng-click="submitLabels()" ng-disabled="!logMgr.modified">Submit Labels</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="column col-12" style="text-align: center" ng-if="user">
                    <div class="divider"></div>
                    <h1 ng-if="user">{{ user }}</h1>
                </div>
                <div class="column col-12">
                    <div class="divider"></div>
                    <div class="form-group">
                        <label class="form-switch">
                            <input type="checkbox" ng-model="displayTableConfig.quickSelect" />
                            <i class="form-icon"></i> Quick Select
                        </label>
                        <label class="form-switch">
                            <input type="checkbox" ng-model="displayTableConfig.score" />
                            <i class="form-icon"></i> Score
                        </label>
                        <label class="form-switch">
                            <input type="checkbox" ng-model="displayTableConfig.user" />
                            <i class="form-icon"></i> User
                        </label>
                        <label class="form-switch">
                            <input type="checkbox" ng-model="displayTableConfig.service" />
                            <i class="form-icon"></i> Service
                        </label>
                        <label class="form-switch">
                            <input type="checkbox" ng-model="displayTableConfig.ip" />
                            <i class="form-icon"></i> IP
                        </label>
                        <label class="form-switch">
                            <input type="checkbox" ng-model="displayTableConfig.device" />
                            <i class="form-icon"></i> Device
                        </label>
                        <label class="form-switch">
                            <input type="checkbox" ng-model="displayTableConfig.geoInfo" />
                            <i class="form-icon"></i> Geo info
                        </label>
                        <label class="form-switch">
                            <input type="checkbox" ng-model="displayTableConfig.timestamp" />
                            <i class="form-icon"></i> Timestamp
                        </label>
                        <label class="form-switch">
                            <input type="checkbox" ng-model="displayTableConfig.label" />
                            <i class="form-icon"></i> Label
                        </label>
                    </div>
                </div>
            </div>
            <div class="column col-12" style="height: 100%">
                <div class="divider"></div>
                <label class="form-switch">
                    <input type="checkbox" ng-model="shoControlPannel" />
                    <i class="form-icon"></i> Show Control Pannel
                </label>
                <ul class="tab tab-block">
                    <li class="tab-item" ng-class="{'active': currentTab=='Table'}">
                        <a href="" ng-click="currentTab='Table'">Table</a>
                    </li>
                    <li class="tab-item" ng-class="{'active': currentTab=='Geo Map'}">
                        <a href="" ng-click="currentTab='Geo Map'">Geo Map</a>
                    </li>
                    <li class="tab-item" ng-class="{'active': currentTab=='Country Pie'}">
                        <a href="" ng-click="currentTab='Country Pie'">Country Pie</a>
                    </li>
                </ul>
                <div class="column col-12" ng-show="currentTab=='Table'">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th ng-show="displayTableConfig.quickSelect"><input type="checkbox" ng-model="useQuickLabel" ng-change="selectAll()" />Select All<br />
                                    <select class="form-select" ng-model="quickLabel" ng-change="updateAllLabel()">
                                        <option></option>
                                        <option>normal</option>
                                        <option>abnormal</option>
                                        <option>whiteList</option>
                                    </select>
                                </th>
                                <th></th>
                                <th ng-show="displayTableConfig.score">Score</th>
                                <th ng-show="displayTableConfig.user">User</th>
                                <th ng-show="displayTableConfig.service">Service</th>
                                <th ng-show="displayTableConfig.ip">IP</th>
                                <th ng-show="displayTableConfig.device">Device</th>
                                <th ng-show="displayTableConfig.geoInfo">Geo Info</th>
                                <th ng-show="displayTableConfig.timestamp">Timestamp</th>
                                <th ng-show="displayTableConfig.label">Label</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr ng-repeat="log in logMgr.logs | filter:localLogFilter">
                                <td ng-show="displayTableConfig.quickSelect"><input type="checkbox" ng-model="log.quickLabelChecked" ng-change="changeLabel(log)"></td>
                                <td>
                                    <button class="btn" ng-click="showLogDetail(log)">Info</button>
                                </td>
                                <td ng-show="displayTableConfig.score">{{ log._source.scores.total | number: 3 }}</td>
                                <td ng-show="displayTableConfig.user">
                                    <button class="btn btn-link" ng-click="openUserTab(log)">{{ log._source.log.user }}</button>
                                </td>
                                <td ng-show="displayTableConfig.service">{{ log._source.log.service }}</td>
                                <td ng-show="displayTableConfig.ip">{{ log._source.log.ip }}</td>
                                <td ng-show="displayTableConfig.device">{{ log._source.log.device | deviceDisplay }}</td>
                                <td ng-show="displayTableConfig.geoInfo">{{ log._source.log.city }}/{{ log._source.log.region }}/{{ log._source.log.country }}</td>
                                <td ng-show="displayTableConfig.timestamp">{{ log._source.log.timestamp }}</td>
                                <td ng-show="displayTableConfig.label"><span class="label" ng-class="{'label-danger': log._source.label.analyst == 'abnormal', 'label-success': log._source.label.analyst == 'normal'}" ng-if="log._source.label.analyst">{{ log._source.label.analyst }}</span></td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="column col-12" style="text-align: center">
                        <button class="btn" ng-click="loadMore()">{{ logMgr.logs.length
                            < logMgr.logTotal ? 'Load More' : 'No More' }} ({{ logMgr.logs.length }} / {{ logMgr.logTotal }})</button>
                    </div>
                </div>
                <div class="column col-12" ng-show="currentTab=='Geo Map'" style="height: 100%">
                    <iframe ng-src="{{ geo_visual_url }}" style='width: 100%;height: 100%;'></iframe>
                </div>
                <div class="column col-12" ng-show="currentTab=='Country Pie'" style="height: 100%">
                    I am Pi chart
                </div>
            </div>
        </div>
    </div>
    <div class="modal" ng-class="{'active':logModal.display}">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <button class="btn btn-clear float-right" ng-click="logModal.display=false;"></button>
                <div class="modal-title">Log Detail Info</div>
            </div>
            <div class="modal-body">
                <div class="content">
                    <div class="container">
                        <div class="column col-12">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th>field</th>
                                        <th>value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>ID</td>
                                        <td>{{ logModal.targetLog._id }}</td>
                                    </tr>
                                    <tr>
                                        <td>Scores</td>
                                        <td>
                                            <ul>
                                                <li ng-repeat="(key, value) in logModal.targetLog._source.scores">{{ key }}: {{ value }}</li>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>Feature Vector</td>
                                        <td>
                                            <ul>
                                                <li ng-repeat="(key, value) in logModal.targetLog._source.features">{{ key }}: {{ value }}</li>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>User</td>
                                        <td>
                                            <button class="btn btn-link" ng-click="openUserTab(logModal.targetLog)">{{ logModal.targetLog._source.log.user }}</button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>IP Info</td>
                                        <td>
                                            <ul>
                                                <li>IP: {{ logModal.targetLog._source.log.ip }}</li>
                                                <li>ISP: {{ logModal.targetLog._source.log.isp }}</li>
                                                <li>Domain: {{ logModal.targetLog._source.log.domain }}</li>
                                                <li>Geo Info: {{ logModal.targetLog._source.log.city }} / {{ logModal.targetLog._source.log.region }} / {{ logModal.targetLog._source.log.country }}</li>
                                                <li>(latitude, longitude): ({{ logModal.targetLog._source.log.location.lat }}, {{ logModal.targetLog._source.log.location.lon }})</li>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>timestamp</td>
                                        <td>{{ logModal.targetLog._source.log.timestamp }}</td>
                                    </tr>
                                    <tr>
                                        <td>Other Info</td>
                                        <td>
                                            <ul>
                                                <li>browser: 
                                                    <ul>
                                                        <li ng-repeat="(key, value) in logModal.targetLog._source.log.browser" >{{ key }}: {{ value }}</li>
                                                    </ul>
                                                </li>
                                                <li>os: 
                                                    <ul>
                                                        <li ng-repeat="(key, value) in logModal.targetLog._source.log.os">{{ key }}: {{ value }}</li></li>
                                                    </ul>
                                            </ul>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>labels</td>
                                        <td>
                                            <ul>
                                                <li>analyst: {{ logModal.targetLog._source.label.analyst || "None" }}</li>
                                            </ul>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="form-group">
                    <label>Label</label>
                    <select class="form-select" ng-model="logModal.targetLog._source.label.analyst" ng-change="updateLabel(logModal.targetLog)">
                        <option></option>
                        <option>normal</option>
                        <option>abnormal</option>
                        <option>whiteList</option>
                    </select>
                    <button class="btn btn-link" ng-click="logModal.display=false;">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal" ng-class="{'active':loadingModal.display}">
        <div class="modal-overlay"></div>
        <div class="modal-container">
            <div class="modal-header">
                <div class="modal-title"></div>
            </div>
            <div class="modal-body">
                <div class="content">
                    <div class="loading"></div>
                    {{ loadingModal.text }}
                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
    <!-- JS -->
    <script type="text/javascript" src="./lib/moment.js"></script>
    <script type="text/javascript" src="./lib/angular.min.js"></script>
    <script type="text/javascript" src="./lib/elasticsearch.angular.min.js"></script>
    <script type="text/javascript" src="./lib/720kb.angular-datepicker/angular-datepicker.min.js"></script>
    <script type="text/javascript" src="./js/app.js"></script>
    <script type="text/javascript" src="./js/config.js"></script>
</body>

</html>
